# library(anema)
library(magrittr)
library(sf)
library(tidyverse)
pts_wgs <- sf::read_sf("../../../genevois/spatial/shp/manual/pts_text.shp") %>%
mutate(rate=rate/100,
type=factor(sign(rate),levels=c(-1,0,1),labels=c("pumping","defunct","injection")))
pts_wgs
boundaries_wgs <- sf::read_sf("../../../genevois/spatial/shp/manual/lines_text.shp")
boundaries_wgs
utm_zone <- longitude_to_utm_zone(6.2)
utm_proj4 <- utm_zone_to_proj4(utm_zone)
pts_utm <- pts_wgs %>% sf::st_transform(utm_proj4)
boundaries_utm <- boundaries_wgs %>% sf::st_transform(utm_proj4)
ggplot() +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes())
wells <- prep_wells_sf(pts_utm) %>%
mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
boundaries <- prep_bounds(boundaries_utm)
grid_bounds <- boundaries %>% st_coordinates() %>% as_tibble() %>%
summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds <- data.frame(xmin=276000,xmax=283000,ymin=5115000,ymax=5120000)
grid_pts_head <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
heads <- get_hydraulic_head(grid_pts_head,wells,h0=10,Ksat=0.00001,z0=10,aquifer_type="confined")
head_df <- grid_pts_head %>% bind_cols(head_m=heads)
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=pts_utm %>% filter(type=="pumping"), aes(size=abs(rate)),shape=1,stroke=1.5) +
geom_sf(data=pts_utm %>% filter(type=="injection"), aes(size=abs(rate)),shape=16) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_size_continuous(limits=c(3,4)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
flow_dir <- get_flowdir(grid_pts_flowdir,wells,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=abs(atan(y/x)),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
flow_dir <- get_flowdir_num(grid_pts_flowdir,wells,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=abs(atan(y/x)),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=log(mag)))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal()+
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*1e2,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag*5e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*5e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
Now, plot the results together.
```{r plot_confined}
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
```
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
well_images <- generate_image_wells(wells,boundaries,num_levels=2) %>%
mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
grid_bounds <- boundaries %>% st_coordinates() %>% as_tibble() %>%
summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds <- data.frame(xmin=273000,xmax=284000,ymin=5113000,ymax=5120000)
grid_pts_head <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
heads <- get_hydraulic_head(grid_pts_head,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
head_df <- grid_pts_head %>% bind_cols(head_m=heads)
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir <- get_flowdir(grid_pts_flowdir,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir <- get_flowdir_num(grid_pts_flowdir,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# flow_dir_check <- flow_dir_df %>% select(dx,dx_norm,dy,dy_norm) %>%
#   mutate(check=sign(dx)==sign(dx_norm) & sign(dy)== sign(dy_norm))
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=log(mag)))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
flow_dir_unconf_df
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir_unconf <- get_flowdir_num(grid_pts_flowdir_unconf,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
flow_dir_df
flow_dir_unconf_df <- flow_dir_df
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir_unconf <- get_flowdir_num(grid_pts_flowdir_unconf,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir_unconf <- flow_dir
flow_dir
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
grid_bounds_unconf <- boundaries %>% st_coordinates() %>% as_tibble() %>%
summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds_unconf <- data.frame(xmin=273000,xmax=284000,ymin=5113000,ymax=5120000)
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_unconf_df) +
geom_raster(aes(x,y,fill=log(mag)))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*2e4,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_unconf_df) +
geom_raster(aes(x,y,fill=log(mag)))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
# plot the flow velocities
ggplot(flow_dir_unconf_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
head_unconf_df
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
head_unconf_df <- head_Df
head_unconf_df <- head_df
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_unconf_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/4)*1e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0,size=abs(rate))) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0),size=2) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0),size=3,shape=1) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
ggplot(head_unconf_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=boundaries_utm, aes()) +
geom_point(data=wells, aes(x=x0,y=y0),size=3,shape=1,stroke=1.5) +
geom_segment(data=flow_dir_unconf_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
boundaries <- data.frame(x1=c(0,10,11,1),y1=c(0,10,9,-1),x2=c(10,11,1,0),y2=c(10,9,-1,0))
ggplot(boundaries) + geom_segment(aes(x1,y1,xend=x2,yend=y2))
#'   data.frame with column names x1, y1, x2, y2, representing the endpoints
#' @return A data.frame containing slope (m) and intercept (b) for each line,
#'   along with original columns. If \code{boundaries} is a data.frame, the columns
#'   x1, y1, x2, y2 are automatically calculated using \code{prep_wells_sf} and
#'   added to the sf object before getting the slope and intercept. The function requires
#'   that the wells are labeled with a column of identifiers, pID. If it is not
#'   present, the function generates them.
#' @importFrom magrittr %>%
#' @examples
#'
boundaries <- data.frame(x1=c(0,10,12,1),y1=c(0,10,9,-1),x2=c(10,12,1,0),y2=c(10,9,-1,0))
ggplot(boundaries) + geom_segment(aes(x1,y1,xend=x2,yend=y2))
#'   data.frame with column names x1, y1, x2, y2, representing the endpoints
#' @return A data.frame containing slope (m) and intercept (b) for each line,
#'   along with original columns. If \code{boundaries} is a data.frame, the columns
#'   x1, y1, x2, y2 are automatically calculated using \code{prep_wells_sf} and
#'   added to the sf object before getting the slope and intercept. The function requires
#'   that the wells are labeled with a column of identifiers, pID. If it is not
#'   present, the function generates them.
#' @importFrom magrittr %>%
#' @examples
#'
boundaries <- data.frame(x1=c(0,10,13,1),y1=c(0,10,9,-1),x2=c(10,13,1,0),y2=c(10,9,-1,0))
ggplot(boundaries) + geom_segment(aes(x1,y1,xend=x2,yend=y2))
devtools::document()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.width=4,
fig.height=2.5
)
devtools::load_all()
# install.packages(".", repos = NULL, type="source")
# library(anema)
library(magrittr)
library(sf)
library(tidyverse)
pts_wgs <- sf::read_sf("../../../genevois/spatial/shp/manual/pts_text.shp") %>%
mutate(rate=rate/100,
type=factor(sign(rate),levels=c(-1,0,1),labels=c("pumping","defunct","injection")))
pts_wgs
boundaries_wgs <- sf::read_sf("../../../genevois/spatial/shp/manual/lines_text.shp")
boundaries_wgs
utm_zone <- longitude_to_utm_zone(6.2)
utm_proj4 <- utm_zone_to_proj4(utm_zone)
pts_utm <- pts_wgs %>% sf::st_transform(utm_proj4)
boundaries_utm <- boundaries_wgs %>% sf::st_transform(utm_proj4)
ggplot() +
geom_sf(data=boundaries_utm, aes()) +
geom_sf(data=pts_utm, aes())
wells <- prep_wells_sf(pts_utm) %>%
mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
boundaries <- prep_bounds(boundaries_utm)
grid_bounds <- boundaries %>% st_coordinates() %>% as_tibble() %>%
summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds <- data.frame(xmin=276000,xmax=283000,ymin=5115000,ymax=5120000)
grid_pts_head <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
heads <- get_hydraulic_head(grid_pts_head,wells,h0=10,Ksat=0.00001,z0=10,aquifer_type="confined")
head_df <- grid_pts_head %>% bind_cols(head_m=heads)
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_sf(data=pts_utm %>% filter(type=="pumping"), aes(size=abs(rate)),shape=1,stroke=1.5) +
geom_sf(data=pts_utm %>% filter(type=="injection"), aes(size=abs(rate)),shape=16) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
scale_size_continuous(limits=c(3,4)) +
scale_shape_manual(values=c(1,16),limits=c(3,4))
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
flow_dir <- get_flowdir(grid_pts_flowdir,wells,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
mutate(angle=atan(x/y),
mag=sqrt(dx^2+dy^2),
mag_norm=mag^(1/2)*2e3,
dx_norm=cos(angle)*sign(dx)*mag_norm,
dy_norm=sin(angle)*sign(dx)*mag_norm,
x2=x+dx_norm,
y2=y+dy_norm)
# plot the flow velocities
ggplot(flow_dir_df) +
geom_raster(aes(x,y,fill=mag_norm))  +
geom_sf(data=pts_utm, aes(),size=3) +
coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
ggplot(head_df) +
geom_raster(aes(x,y,fill=head_m))  +
geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
geom_segment(data=flow_dir_df,
aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
coord_equal() +
# coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
well_images <- generate_image_wells(wells,boundaries,num_levels=2) %>%
mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
