---
title: "anem-publication"
output: 
  html_notebook:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=4, 
  fig.height=2.5
)
```

```{r include = FALSE}
library(anem)
library(tidyverse)
```


### Abstract 

Numerous tools exist for simulating groundwater flow via finite element models (e.g., MODFLOW) or analytic element models (e.g., gflow).
These tools allow for analysis of complex groundwater behavior, but such functionality that may not be necessary projects that demand simple groundwater models combined with (1) ease of use or (2) advanced statistical or theoretical analysis.
We address each of these needs through the development of a web application and an R package that simulate 2-dimensional, steady-state groundwater flow in confined and unconfined aquifers with rectangular boundaries using analytic elements and the method of well images.
Both tools can be used independent of the computer platform, and offer functionality for defining aquifers and pumping wells, determining hydraulic head and lateral flow, calculating drawdown relationships among groups of wells, and estimating travel times for particles.
The ease of use of the web application should be especially valuabe in low-budget applications, such as small water management agencies or educational settings.
Integration of groundwater models with R can provide numerous benefits for quickly simulating and analyzing groundwater hydrology problems.
Such simulation can serve as a precursor to more complex groundwater modeling, or be used to simulate synthetic scenarios as a way to explore variability and uncertainty.
Because R is a functional programming language, the outputs from this package can be easily analyzed, mapped, and incorporated into more complex models in R.
Indeed, the linear behavior of groundwater flow and principle of superposition means that physically plausible groundwater dynamics can be incorporated into more complex models of hydrology and coupled human-natural systems.
We validate the code and describe multiple scenarios in which the web application and R package might be used.


**[Feo et al, 2018](https://ngwa.onlinelibrary.wiley.com/doi/abs/10.1111/gwat.12588)**

*Introduction*

* General motivation
* Existing models
* Common approaches
* Overview of new contribution
* Description of new contribution

*Basic concepts and outline of problem*


## Introduction

Groundwater plays an essential role in environmental and water resources management. In various contexts it may serve as a resource, hazard, or transport medium. As such, groundwater modeling is ubiquitous for a variety of applications in industry, academia, and policy, witth applications ranging from abstraction economics to environmental remediation. The fundamental principles of groundwater dynamics are mathematically simple and commonly taught in civil and environmental engineering courses. However, there remains an uncessary learning curve to bridge the divide between the simplicity of groundwater equations and the tools available to model groundwater.

Groundwater models can be broadly categorized into numerical and analytical approaches. Numerical models simulate groundwater behavior using a finite-element representation of Richard's equation. Groundwater hydraulics are simulated on a discrete grid by stepping forward through time such that each time step solves the discrete version of Richard's equation. The most common numerical, MODFLOW, is freely available, can be implemented across platforms, and has become widely adopted as computational efficiency has improved to make the necessary computational resources more widely available. 

Analytical models utilize the analytical element method, whereby two-dimensonal, steady-state versions of the groundwater equations are combined to reproduce groundwater behavior under simplifying assumptions. This approach is aptly named as groundwater dynamics depend on sum of analytical solutions due to one or more elements in the groundwater scenario. This approach is viable because the groundwater equations are linear, meaning that the solution to a number of elements is identical to the sum of the solution to each of the elements.

Although existing tools offer a variety options for modeling groundwater behavior, they exhibit shortcomings. Although MODFLOW can run on Windows or Unix systems, the avilable graphical user interface (GUI) only runs on Windows. Most of freely available analytical element models are also built for Windows and not mac. 
Existing modeling tools suffice when the stakes are high or sufficient resources are available. One exception is the python package by Bakker (timml). 

We present two related platforms for groundwater modeling that offer additional flexibility and make groundwater modeling more readily accessible for simple scenarios. The first is an R package, anem, which models simple groundwater scenarios. It it based on method of images from the analytical element modeling approach, in which the 2-dimensional characteristics of aquifers are reproduced by strategically placing wells within the domain. It provides speicific functionality to evaluate the hydraulic relationships among wells, in order to estimate the effect of a group of wells on drawdown at these wells or other wells.

This package models *simple* aquifer and well configurations. The boundaries of the aquifer can be specified as *no flow* or *constant head* boundaries, and the corners of the aquifer must be right angles. For fully bounded aquifers, this means that the aquifer must be a rectangle. The package allows for constant background flow, any number of pumping or injection wells, as well as particle tracking. For practical purposes, the package was designed for simple but real aquifers, and wells and boundaries of the aquifers can be imported as shapefiles and then prepared. 

```{r f1_prep, fig.width=6,fig.height=1.5,include=FALSE}
bounds_df <- define_bounds(tibble(bound_type=c("PB","PB","CH","NF"),m=c(Inf,0,Inf,0),b=c(0,5000,5000,0)))
recharge_params <- list(recharge_type="F", recharge_vector=c(0,0,1,0),
                        flow=5e-6, x0=5000, y0=5000)
aquifer <- define_aquifer("confined", 1e-3, h0=0, z0=10,
                          bounds=bounds_df,recharge=recharge_params)
wells_orig <- define_wells(x=c(1000,1700,3500,4000),y=c(4000,1700,3500,1000),
                      R=rep(4000,4),diam=rep(1,4),Q=c(-0.02,-0.02,0.02,-0.02))
wells <- wells_orig %>%
  anem::generate_image_wells(aquifer)
# wells <-  define_wells(x=2500,y=2500,
#                       R=6000,diam=1,Q=-0.01) %>%
#     anem::generate_image_wells(aquifer)

# anem::get_gridded_hydrodynamics()
loc <- crossing(x=seq(0,10000,length.out=201),y=seq(-5000,5000,length.out=201))

thm <- theme(panel.background = element_rect(fill=NA,color=NA),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position="none",axis.text=element_blank(),
        axis.ticks=element_blank(),axis.title=element_blank(),
        legend.title=element_text(size=14),
        legend.text=element_text(size=12),
        legend.spacing = unit(1,"mm"))

p_base <- ggplot() +
  geom_segment(data=aquifer$bounds %>%
                 mutate(bt=factor(bound_type,levels=c("CH","NF","PB"),
                                  labels=c("River","No flow","Open"))),
               aes(x1,y1,xend=x2,yend=y2,color=bt),size=1) +
  scale_shape_manual("Well type",values = c(16,1,4,3)) +
  scale_color_manual("Boundary",values = c("blue","#555555","#CCCCCC"))
```

```{r f1a, fig.width=1.8,fig.height=1.5,include=FALSE}
well_color <- "#AA3333"
f1_a <- p_base +
  geom_point(data=wells %>% filter(well_image=="Actual",orig_wID!=4),
             aes(x,y,shape=well_type),size=3,stroke=1) +
  geom_point(data=wells %>% filter(well_image=="Actual",orig_wID==4),
             aes(x,y,shape=well_type),size=3,stroke=1,color=well_color,show.legend = FALSE) +
  coord_equal() +
  thm %+replace% theme(legend.position = "left")
```

```{r f1b, fig.width=6,fig.height=1.5,include=FALSE}

wells_roi <- wells %>% filter(orig_wID==4) %>% anem::gen_circles()
f1_b <- p_base +
  geom_polygon(data=wells_roi,aes(x,y,group=id),fill=well_color,alpha=0.2,color=well_color,size=0.25) +
  geom_point(data=wells %>% filter(well_image=="Actual",orig_wID!=4),
             aes(x,y,shape=well_type),size=3,stroke=1,alpha=0.5) +
  # geom_point(data=wells %>% filter(well_image=="Actual",orig_wID==4),
  #            aes(x,y,shape=well_type),size=3,stroke=1,color=well_color) +
  geom_point(data=wells %>% filter(well_image=="Actual",orig_wID==4),aes(x,y,shape=well_type),
             size=2,stroke=1,color=well_color) +
  geom_point(data=wells %>% filter(well_image!="Actual",orig_wID==4),aes(x,y,shape=well_type),
             size=2,stroke=1,color=well_color) +
  annotate("rect",xmin=3500,xmax=6500,ymin=-1500,ymax=1500,color="#992222",linetype="dashed",fill=NA,size=1) +
  coord_equal() +
  thm
```

```{r f1c, fig.width=6,fig.height=1.5,include=FALSE}
streamfunction <- loc %>%
  dplyr::bind_cols(streamfunction=get_stream_function(loc,wells %>% filter(orig_wID==4),aquifer)) %>%
  dplyr::bind_cols(head=get_hydraulic_head(loc,wells,aquifer))

flowlines <- anem::get_contourlines(streamfunction %>% rename(z=streamfunction),nlevels=40)
f1_c <- p_base +
  geom_path(data=flowlines,aes(x,y,group=line),color="#66CCEE",alpha=1) +
  geom_point(data=wells %>% filter(well_image=="Actual"),aes(x,y,shape=well_image),
             size=2,stroke=1,color="#AA3333") +
  geom_point(data=wells %>% filter(well_image!="Actual"),aes(x,y,shape=well_image),
             size=2,stroke=1,color="#AA3333") +
  annotate("rect",xmin=3500,xmax=6500,ymin=-1500,ymax=1500,color="#AA3333",linetype="dashed",fill=NA,size=1) +
  coord_equal(xlim=c(3500,6500),ylim=c(-1500,1500)) +
  scale_shape_manual(values=c(16,0,15))+
  thm #%+replace% theme(legend.position = "right")
```

```{r f1d, fig.width=6,fig.height=1.5,include=FALSE}
wells_actual <- wells %>% filter(well_image=="Actual")
gridded <- get_gridded_hydrodynamics(wells,aquifer,head_dim=c(200,200),flow_dim=c(10,10))
x_multiplier <- 3e5
missing_points <- 
  do.call(rbind,lapply(split(wells_actual,seq(nrow(wells_actual))),
                       function(loc,df) df[which.min(sqrt((df$x - loc$x)^2 + 
                                                            (df$y - loc$y)^2))[1],c("x","y")], df=gridded$flow))
gridded$flow <- gridded$flow %>% 
  mutate(x2 = x + dx * x_multiplier,y2 = y + dy * x_multiplier) %>%
  anti_join(missing_points,by=c("x","y"))
contours <- get_contourlines(gridded$head %>% rename(z=head_m),nlevels=20)
  
f1_d <- ggplot() +
  geom_raster(data=gridded$head,aes(x,y,fill=head_m)) +
  # geom_path(data=contours,aes(x,y,group=line)) +
  geom_segment(data=aquifer$bounds %>%
                 mutate(bt=factor(bound_type,levels=c("CH","NF","PB"),
                                  labels=c("River","No flow","Open (no boundary)"))),
               aes(x1,y1,xend=x2,yend=y2,color=bt),size=1,show.legend = FALSE) +
  geom_segment(data=gridded$flow,aes(x,y,xend=x2,yend=y2),
               arrow = arrow(ends="last",type="closed",length=unit(1,"mm")),color="black") +
  geom_point(data=wells %>% filter(well_image=="Actual"),
             aes(x,y,shape=well_type),size=3,stroke=1,show.legend = FALSE) +
  scale_shape_manual("Well type",values = c(16,1,4,3)) +
  scale_color_manual("Boundary",values = c("blue","#555555","#CCCCCC")) +
  scale_fill_viridis_c("Hydraulic\nhead, m",breaks=-1:2,labels=c("-1","0 (river)","1","2")) +
  coord_equal() + thm %+replace% theme(legend.position = "right")
```

**Introduction**

Groundwater modeling background:

1. needs
1. existing tools
    * MODFLOW
    * gflow
    * Bakker python packages
    * other software packages
1. motivation for this package
    * ease of use
    * integration with R, data analytics
    * precursor to more complex groundwater models
    * component of more complex hydrological models or coupled models
    
## R package: anem

### Principle of superposition

### Analytic elements

The analytic element method represents the aquifer domain as the sum of analytical solutions of multiple elements added to the aquifer. 

**Pumping from a single well**

We assume that all flow within the aquifer follows the Depuit-Forschheimer assumption such that all flow is 2-Dimensional and parallel to the aquifer bottom, which is horizontal. Flow is governed by Darcy's law which, in the case of radial flow to a well, can be integrated to obtain the Thiem solution describing steady state hydraulic head and flow in the vicinity ($r<R$) of a pumping well:

\begin{align}
h - h_0 = -\frac{Q}{2 \pi T} \log \left( \frac{r}{R} \right)
\label{eq:thiemunconfined}
\end{align}

where $h$ is hydraulic head at a distance $r$ from a fully penetrating well that pumps at rate $Q$ (positive for injection, negative for abstraction), $h_0$ is the undisturbed hydraulic head when $Q=0$, $T$ is the transmissivity of the confined aquifer defined as saturated hydraulic conductivity multiplied by the thickness of the aquifer ($T= K_{sat} z_0$), and $R$ is the radius of influence of the pumping well, outside of which the hydraulic head is undisturbed by pumping ($h=h_0$). This solution is valid for steady state flow in confined aquifers.

The solution can also be written for unconfined aquifers in terms of *discharge potential*, $\phi$:
$$\phi - \phi_0 = -\frac{Q}{\pi K_{sat}} \log \left( \frac{r}{R} \right),$$
where discharge potential is defined as $\phi=h^2$, and $\phi_0$ is the undisturbed discharge potential when $Q=0$.


```{r f1_plot, fig.width=6,fig.height=1.2,echo=FALSE}
gridExtra::grid.arrange(f1_a,f1_b,f1_c,f1_d,nrow=1,widths=c(0.32,0.2,0.2,0.32))
```

```{r echo=FALSE, message=FALSE,warning=FALSE}
library(tidyverse)
library(sf)
# devtools::install_github("https://github.com/gopalpenny/anem")
# devtools::load_all("~/Projects/R_packages/anem")
library(anem)
```




### A simple example of drawdown relationships

Load packages for the vignette

```{r setup, eval=FALSE}
library(tidyverse)
library(sf)
# devtools::install_github("https://github.com/gopalpenny/anem")
# devtools::load_all("~/Projects/R_packages/anem")
library(anem)
```

Aquifers in this package are characterized by:

* Aquifer type, confined or unconfined
* Saturated hydraulic conductivity, Ksat
* Resting hydraulic head, h0
* Thickness of the aquifer, z0 (confined aquifers only)
* Aquifer boundaries, characterized by:
  + Boundary ID, or bID
  + Coordinates in a cartesian plane, given as slope, m, and intercept, b, and coordinates (x1, y1, x2, y2)
  + Boundary type, NF or CH
* Additional user-defined parameters

Use the `define_aquifer()` function to create a new aquifer, which has the class `aquifer`. This class is essentially a list with names parameters and a separate print method.

```{r}
# define aquifer
bounds_df <- data.frame(bound_type=c("CH","NF","NF","NF"),m=c(Inf,0,Inf,0),b=c(0,1000,1000,0))
aquifer_unconfined <- define_aquifer("unconfined",1e-3,bounds=bounds_df,h0=100)
```

Wells are characterized by:

* Well ID, or wID
* Location x, y
* Pumping rate (+ for injection, - for pumping), Q
* Radius of influence, R
* Diameter, diam
* Well images (which are noted in the `well_image` column)
* Additional user-defined columns, including groups or weights.

The code below Defines 8 pumping wells using random locations and arbitrarily divides wells into countries "A" and "B" using a threshold at y = 500 m. The `define_wells()` function ensures that the wells have all appropriate columns, and the class of the returned object is a `tibble` (which functions like a `data.frame`, but has a couple bells and whistles). Also note that the radius of influence (R) is defined arbitrarily, but there is also a function to calculate this manually -- see `?get_ROI` for more details.

The `generate_image_wells()` function generates well images to recreate the bounderies defined by the aquifer, `aquifer_unconfined`.

```{r set_simple_aquifer}
# define wells and well images
set.seed(15)
wells_actual <- define_wells(x = runif(8,0,1000),
                             y = c(runif(4,0,500),runif(4,500,1000)),
                             Q = -1/4,
                             diam = 1,
                             R = 1000,
                             weights = 1,
                             country = rep(c("A","B"),each=4))
wells <- wells_actual %>% generate_image_wells(aquifer_unconfined)
```

Plot the aquifer and wells.

```{r set_simple_wells,echo=FALSE}
ggplot() +
  geom_segment(data=aquifer_unconfined$bounds,aes(x1,y1,xend=x2,yend=y2,color=bound_type)) +
  geom_abline(slope=0,intercept=500,linetype="dashed") +
  geom_point(data=wells_actual,aes(x,y,fill=country),shape=21) +
  coord_equal()
```

Get drawdown relationships using `get_drawdown_relationships()`. This function calculates the average drawdown at wells in each group defined by the column `group_column`. The average is taken as the weighted mean, determined by the `weights_column`. The weights were previously set equal for all wells so that the result here is a simple mean. The results show $\Phi_{ii}$ and $\Phi_{ij}$.

```{r drawdown_relationships,results='hide'}
drawdown_relationships <- get_drawdown_relationships(wells, aquifer_unconfined, country, weights)
```

```{r print_drawdown_kable,echo=FALSE}
drawdown_relationships %>% 
  knitr::kable("html") #%>% kableExtra::kable_styling()
```

### Plot the head and flow

The hydrodynamics of the aquifer can be mapped by obtaining gridded heand flow using the `get_gridded_hydrodynamics()` function. The function takes as input the wells, aquifer, and grid dimensions for head and flow. It returns a `list` object with data.frames for head and flow, which can then be plotted.

```{r}
gridded <- get_gridded_hydrodynamics(wells,aquifer_unconfined,c(20,20),c(8,8))
```

```{r echo=FALSE, warning=FALSE}
ggplot() +
  geom_raster(data=gridded$head,aes(x,y,fill=head_m)) +
  geom_segment(data=gridded$flow,aes(x,y,xend=x2,yend=y2),
               arrow = arrow(ends="last",type="closed",length=unit(1,"mm")),color="black") +
  geom_segment(data=aquifer_unconfined$bounds,aes(x1,y1,xend=x2,yend=y2,color=bound_type)) +
  geom_point(data=wells %>% filter(wID==orig_wID),aes(x,y),shape=21) +
  coord_equal()
```


**Package description**

Basic functionality of the package

1. defining wells and aquifers in `anem`
1. generating drawdown relationships

**Theoretical background**

1. groundwater theory
    * flow equations
    * principle of superposition
    * confined and unconfined flow

## Web application


    
**Web application**

1. Interface
    * Overview -- map-based interactive tool. Leaflet & open street map to immediately access basemaps. This interface is useful to seamlessly connect model results with physical setting.
    * Prepare scenario & view results tabs
1. Prepare scenario
1. View results

## Use cases



**Use cases**

1. Pumping tests?
1. Well placement? (ie., drawdown relationships for wells at the boundary vs center of the aquifer?)
1. Game theory?
1. Dynamical systems?
