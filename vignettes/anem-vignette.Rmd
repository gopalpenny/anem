---
title: "anem-vignette"
author: "Gopal Penny"
date: "` r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{anema-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=4, 
  fig.height=2.5
)
# devtools::install()
```

This package was created to evaluate the hydraulic relationships among wells, in order to estimate the effect of a group of wells on drawdown at these wells or other wells. It it based on method of images from the analytical element modeling approach, in which the 2-dimensional characteristics of aquifers are reproduced by strategically placing wells within the domain.

This package models *simple* aquifer and well configurations. The boundaries of the aquifer can be specified as *no flow* or *constant head* boundaries, and the corners of the aquifer must be right angles. For fully bounded aquifers, this means that the aquifer must be a rectangle. The constant head boundaries take the head of the undisturbed aquifer, h0.

Units are designed for length dimensions given in meters (or m^2^), and time in seconds

As you will see in this vignette, the package has a number of functions that are used to set up the aquifer boundaries and wells. For practical purposes, the package was designed for simple but real aquifers, and wells and boundaries of the aquifers can be imported as shapefiles and then prepared. 

The first section, however, describes how to obtain drawdown relationships between groups of wells.

## A simple example of drawdown relationships

Load packages for the vignette

```{r setup, message=FALSE,warning=FALSE}
library(tidyverse)
library(sf)
# devtools::install_github("https://github.com/gopalpenny/anem")
# devtools::load_all("~/Projects/R_packages/anem")
library(anem)
```

Aquifers in this package are characterized by:

* Aquifer type, confined or unconfined
* Saturated hydraulic conductivity, Ksat
* Resting hydraulic head, h0
* Thickness of the aquifer, z0 (confined aquifers only)
* Aquifer boundaries, characterized by:
  + Boundary ID, or bID
  + Coordinates in a cartesian plane, given as slope, m, and intercept, b, and coordinates (x1, y1, x2, y2)
  + Boundary type, NF or CH
* Additional user-defined parameters

Use the `define_aquifer()` function to create a new aquifer, which has the class `aquifer`. This class is essentially a list with names parameters and a separate print method.

```{r}
# define aquifer
bounds_df <- data.frame(bound_type=c("CH","NF","NF","NF"),m=c(Inf,0,Inf,0),b=c(0,1000,1000,0))
aquifer_unconfined <- define_aquifer("unconfined",1e-3,bounds=bounds_df,h0=100)
print(aquifer_unconfined)
```

Wells are characterized by:

* Well ID, or wID
* Location x, y
* Pumping rate (+ for injection, - for pumping), Q
* Radius of influence, R
* Diameter, diam
* Well images (which are noted in the `well_image` column)
* Additional user-defined columns, including groups or weights.

The code below Defines 8 pumping wells using random locations and arbitrarily divides wells into countries "A" and "B" using a threshold at y = 500 m. The `define_wells()` function ensures that the wells have all appropriate columns, and the class of the returned object is a `tibble` (which functions like a `data.frame`, but has a couple bells and whistles). Also note that the radius of influence (R) is defined arbitrarily, but there is also a function to calculate this manually -- see `?get_ROI` for more details.

The `generate_image_wells()` function generates well images to recreate the bounderies defined by the aquifer, `aquifer_unconfined`.

```{r set_simple_aquifer}
# define wells and well images
set.seed(15)
wells_actual <- define_wells(x = runif(8,0,1000),
                             y = c(runif(4,0,500),runif(4,500,1000)),
                             Q = -1/4,
                             diam = 1,
                             R = 1000,
                             weights = 1,
                             country = rep(c("A","B"),each=4))
wells <- wells_actual %>% generate_image_wells(aquifer_unconfined)
print(wells)
```

Plot the aquifer and wells.

```{r set_simple_wells}
ggplot() +
  geom_segment(data=aquifer_unconfined$bounds,aes(x1,y1,xend=x2,yend=y2,color=bound_type)) +
  geom_abline(slope=0,intercept=500,linetype="dashed") +
  geom_point(data=wells_actual,aes(x,y,fill=country),shape=21) +
  coord_equal()
```

Get drawdown relationships using `get_drawdown_relationships()`. This function calculates the average drawdown at wells in each group defined by the column `group_column`. The average is taken as the weighted mean, determined by the `weights_column`. The weights were previously set equal for all wells so that the result here is a simple mean. The results show $\Phi_{ii}$ and $\Phi_{ij}$.

```{r drawdown_relationships,results='hide'}
drawdown_relationships <- get_drawdown_relationships(wells, aquifer_unconfined, group_column=country, weights_column=weights)
drawdown_relationships
```

```{r print_drawdown_kable,echo=FALSE}
drawdown_relationships %>% 
  knitr::kable("html") #%>% kableExtra::kable_styling()
```

### Plot the head and flow

The hydrodynamics of the aquifer can be mapped by obtaining gridded heand flow using the `get_gridded_hydrodynamics()` function. The function takes as input the wells, aquifer, and grid dimensions for head and flow. It returns a `list` object with data.frames for head and flow, which can then be plotted.

```{r}
gridded <- get_gridded_hydrodynamics(wells,aquifer_unconfined,c(20,20),c(8,8))

ggplot() +
  geom_raster(data=gridded$head,aes(x,y,fill=head_m)) +
  geom_segment(data=gridded$flow,aes(x,y,xend=x2,yend=y2),
               arrow = arrow(ends="last",type="closed",length=unit(1,"mm")),color="black") +
  geom_segment(data=aquifer_unconfined$bounds,aes(x1,y1,xend=x2,yend=y2,color=bound_type)) +
  geom_point(data=wells %>% filter(wID==orig_wID),aes(x,y),shape=21) +
  coord_equal()
```

### Check the head and flow along the boundaries

The function `get_bounds_behavior()` is a helper function to generate hydraulic properties at the boundaries. It obtains hydraulic head and the flow normal to the boundary. Normal flow is defined such that positive flow has some component in the x-direction (the y-direction depends on the normal vector for the boundary). The function `plot_bounds_behavior()` is a wrapper around `get_bounds_behavior()`, and it can be used to quickly compare the hydraulic head along the boundaries and flow across the boundaries under two scenarios: 

* no images (ie, homogeneous, uniform aquifer -- all well images removed)
* images (ie, aquifer with boundaries -- all well images intact)

```{r check_bounds,fig.width=6,fig.height=4}
bounds_behavior <- plot_bounds_behavior(wells,aquifer_unconfined)
gridExtra::grid.arrange(bounds_behavior$p_h,bounds_behavior$p_f,nrow=1)
```

Finally, the function `plot_bounds_behavior` also includes the raw data of head and flow used to create the above plots (`bounds_behavior$bounds_behavior`), as well as a summary of these values which includes mean head on each of the boundaries and mean flow as the mean of the absolute value of flow normal to each boundary (`bounds_behavior$table`). To numerically check that the boundaries are working as expected, we can print `bounds_behavior$table`:

```{r echo=FALSE}
bounds_behavior$table %>% 
  knitr::kable("html") #%>% kableExtra::kable_styling()
```

