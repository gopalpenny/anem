---
title: "anema-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{anema-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=4, 
  fig.height=2.5
)
devtools::load_all()
```

## Intialization and data prep

```{r setup}
# install.packages(".", repos = NULL, type="source")
# library(anema)
library(magrittr)
library(sf)
library(tidyverse)
# devtools::load_all("~/Projects/R_packages/anem")
devtools::load_all()
```

Let's begin by loading some data to practice with. The data are stored in two shapefiles, one `wells` shapefile containing point features with attributes for `rate` and `diameter`, and a second `boundaries` shapefile with `bound_type`.

```{r data_import}
pts_wgs <- sf::read_sf("../../../CNH/genevois/spatial/shp/manual/pts_text.shp") %>%
  mutate(rate=rate/100,
         type=factor(sign(rate),levels=c(-1,0,1),labels=c("pumping","defunct","injection")))
pts_wgs

boundaries_wgs <- sf::read_sf("../../../CNH/genevois/spatial/shp/manual/lines_text.shp") 
boundaries_wgs
```

The coordinates of objects should be in a planar coordinate system in meters. Tranform both of the shapefiles to UTM projection, first by getting the UTM zone and proj4string transforming the shapefiles.

```{r transform_to_planar}
utm_zone <- longitude_to_utm_zone(6.2)
utm_proj4 <- utm_zone_to_proj4(utm_zone)
pts_utm <- pts_wgs %>% sf::st_transform(utm_proj4)
boundaries_utm <- boundaries_wgs %>% sf::st_transform(utm_proj4)

ggplot() + 
  geom_sf(data=boundaries_utm, aes()) + 
  geom_sf(data=pts_utm, aes())
```

We now need to extract the coordinates of the wells and boundaries, as well as get the slope (m) and intercept (b) of the boundaries.

```{r prep_dataframes}
wells <- prep_wells_sf(pts_utm) %>%
  mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
boundaries <- prep_bounds(boundaries_utm,get_rectangular = TRUE)
```

## Two wells in a uniform confined aquifer

### Generating hydraulic head

The `wells` object contains a row for each well. Because of the principle of superposition,
the hydraulic head at any given location is the sum of the effect on hydraulic head of all pumping wells.

First define set of coordinates with which to calculate head by defining a bounding box (`grid_bounds`) and
using `expand.grid` and `seq` to generate evenly spaced points in the variable `grid_pts_head`. Then, use
these points and the `well_images` to generate hydraulic head using `get_hydraulic_head()`.

```{r hydraulic_head_confined,fig.width=6,fig.height=3.5}
grid_bounds <- boundaries %>% st_coordinates() %>% as_tibble() %>%
  summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds <- data.frame(xmin=276000,xmax=283000,ymin=5115000,ymax=5120000)
grid_pts_head <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
heads <- get_hydraulic_head(grid_pts_head,wells,h0=10,Ksat=0.00001,z0=10,aquifer_type="confined")
head_df <- grid_pts_head %>% bind_cols(head_m=heads)

ggplot(head_df) + 
  geom_raster(aes(x,y,fill=head_m))  + 
  geom_sf(data=pts_utm %>% filter(type=="pumping"), aes(size=abs(rate)),shape=1,stroke=1.5) +
  geom_sf(data=pts_utm %>% filter(type=="injection"), aes(size=abs(rate)),shape=16) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_size_continuous(limits=c(3,4)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```

### Get flow direction

Getting flow direction is similar to getting hydraulic head -- the function `get_flowdir()` is a wrapper
around `get_hydraulic_head()` that incorporates a numeric derivative from the package `numDeriv`. Similar
to before, define set of coordinates of evenly spaced points. Then, use
these points and the `well_images` to generate hydraulic head using `get_flowdir()`.

```{r flowdir_confined}
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
flow_dir <- get_flowdir(grid_pts_flowdir,wells,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
  mutate(angle=atan(x/y),
         mag=sqrt(dx^2+dy^2),
         mag_norm=mag^(1/2)*2e3,
         dx_norm=cos(angle)*sign(dx)*mag_norm,
         dy_norm=sin(angle)*sign(dx)*mag_norm,
         x2=x+dx_norm,
         y2=y+dy_norm)

# plot the flow velocities
ggplot(flow_dir_df) + 
  geom_raster(aes(x,y,fill=mag_norm))  + 
  geom_sf(data=pts_utm, aes(),size=3) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
```

Now, plot the results together. 
```{r plot_confined}
ggplot(head_df) +
  geom_raster(aes(x,y,fill=head_m))  +
  geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
  geom_segment(data=flow_dir_df,
               aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
  coord_equal() +
  # coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
```

## Two wells in an aquifer with bounds on all sides

### Generating well images

To reproduce the boundaries, we need to generate image wells by mirroring wells across each of the boundaries. Wells are mirrored across no-flow ("NF") boundaries with the inverse rate of pumping, and across constant head ("CH") boundaries with the same pumping rate.

* This has not been tested with complex boundaries.
  + Use only straight lines.
  + No complex shapes.
  
Lastly, to know the effect of a well on any given location, we need to know the radius of influence of the well. This package provides a couple ways to do this through the `get_radius_of_influence` function. See `?get_radius_of_influence` for more resources. 

```{r imaging}
well_images <- generate_image_wells(wells,boundaries,num_levels=2) %>%
  mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov"))
```


### Generating hydraulic head

The `well_images` object contains a row for each pumping well. Because of the principle of superposition,
the hydraulic head at any given location is the sum of the effect on hydraulic head of all pumping wells.

First define set of coordinates with which to calculate head by defining a bounding box (`grid_bounds`) and
using `expand.grid` and `seq` to generate evenly spaced points in the variable `grid_pts_head`. Then, use
thes points and the `well_images` to generate hydraulic head using `get_hydraulic_head()`.

```{r hydraulic_head_unconfined,fig.width=6,fig.height=3.5}
grid_bounds_unconf <- boundaries %>% st_coordinates() %>% as_tibble() %>%
  summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds_unconf <- data.frame(xmin=273000,xmax=284000,ymin=5113000,ymax=5120000)
grid_pts_head_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=3),y=seq(ymin,ymax,length.out=2)))
heads_unconf <- get_hydraulic_head(grid_pts_head,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
head_unconf_df <- grid_pts_head_unconf %>% bind_cols(head_m=heads)

ggplot(head_unconf_df) + 
  geom_raster(aes(x,y,fill=head_m))  + 
  geom_sf(data=boundaries_utm, aes()) + 
  geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```

### Get flow direction

Getting flow direction is similar to getting hydraulic head -- the function `get_flowdir()` is a wrapper
around `get_hydraulic_head()` that incorporates a numeric derivative from the package `numDeriv`. Similar
to before, define set of coordinates of evenly spaced points. Then, use
these points and the `well_images` to generate hydraulic head using `get_flowdir()`.

```{r flowdir_unconfined}
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=3),y=seq(ymin,ymax,length.out=2)))
flow_dir_unconf <- get_flowdir(grid_pts_flowdir_unconf,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
  mutate(angle=atan(x/y),
         mag=sqrt(dx^2+dy^2),
         mag_norm=mag^(1/4)*1e3,
         dx_norm=cos(angle)*sign(dx)*mag_norm,
         dy_norm=sin(angle)*sign(dx)*mag_norm,
         x2=x+dx_norm,
         y2=y+dy_norm)
# flow_dir_check <- flow_dir_df %>% select(dx,dx_norm,dy,dy_norm) %>%
#   mutate(check=sign(dx)==sign(dx_norm) & sign(dy)== sign(dy_norm))

# plot the flow velocities
ggplot(flow_dir_unconf_df) + 
  geom_raster(aes(x,y,fill=mag_norm))  + 
  geom_sf(data=boundaries_utm, aes()) + 
  geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```


Now, plot the results together. 
```{r plot_unconfined}
ggplot(head_unconf_df) +
  geom_raster(aes(x,y,fill=head_m))  +
  geom_sf(data=boundaries_utm, aes()) +
  geom_point(data=wells, aes(x=x0,y=y0),size=3,shape=1,stroke=1.5) +
  geom_segment(data=flow_dir_unconf_df,
               aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
```

