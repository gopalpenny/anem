---
title: "anem-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{anema-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=4, 
  fig.height=2.5
)
devtools::load_all()
```

## Intialization and data prep

```{r setup, message=FALSE,warning=FALSE}
# install.packages(".", repos = NULL, type="source")
# library(anem)
library(magrittr)
library(sf)
library(tidyverse)
devtools::load_all("~/Projects/R_packages/anem")
```

### Examine the data

Let's begin by loading some data to practice with. The data are stored in two shapefiles, one `wells` shapefile containing point features with attributes for `rate` and `diameter`, and a second `boundaries` shapefile with `bound_type`.

```{r data_import}
pts_wgs <- sf::read_sf("../../../CNH/genevois/spatial/shp/manual/pts_text.shp") %>%
  mutate(rate=rate/100,
         type=factor(sign(rate),levels=c(-1,0,1),labels=c("pumping","defunct","injection")))
pts_wgs

boundaries_wgs <- sf::read_sf("../../../CNH/genevois/spatial/shp/manual/lines_text.shp") 
boundaries_wgs
```

### Plot the data

The coordinates of objects should be in a planar coordinate system in meters. Tranform both of the shapefiles to UTM projection, first by getting the UTM zone and proj4string transforming the shapefiles.

```{r transform_to_planar}
utm_zone <- longitude_to_utm_zone(6.2)
utm_proj4 <- utm_zone_to_proj4(utm_zone)
pts_utm <- pts_wgs %>% sf::st_transform(utm_proj4)
boundaries_utm <- boundaries_wgs %>% sf::st_transform(utm_proj4)

ggplot() + 
  geom_sf(data=boundaries_utm, aes()) + 
  geom_sf(data=pts_utm, aes())
```

### Prep the data 

We now need to extract the coordinates of the wells and boundaries, as well as get the slope (m) and intercept (b) of the boundaries.

```{r prep_dataframes}
wells <- prep_wells_sf(pts_utm) %>%
  mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*20,n=0.4,method="aravin-numerov")) %>%
  mutate(rate=c(-0.03,0.01))
boundaries <- prep_bounds(boundaries_utm,get_rectangular = TRUE)

ggplot() + 
  geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray") + 
  geom_sf(data=boundaries, aes(color=as.factor(bGroup))) + 
  geom_sf(data=pts_utm, aes())
```

## Two wells in a uniform confined aquifer

### Generate hydraulic head

The `wells` object contains a row for each well. Because of the principle of superposition,
the hydraulic head at any given location is the sum of the effect on hydraulic head of all pumping wells.

First define set of coordinates with which to calculate head by defining a bounding box (`grid_bounds`) and
using `expand.grid` and `seq` to generate evenly spaced points in the variable `grid_pts_head`. Then, use
these points and the `well_images` to generate hydraulic head using `get_hydraulic_head()`.

```{r hydraulic_head_confined,fig.width=6,fig.height=3.5}
grid_bounds <- boundaries %>% st_coordinates() %>% as_tibble() %>%
  summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds <- data.frame(xmin=276000,xmax=283000,ymin=5115000,ymax=5120000)
grid_pts_head <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=150),y=seq(ymin,ymax,length.out=100)))
heads <- get_hydraulic_head(grid_pts_head,wells,h0=10,Ksat=0.00001,z0=10,aquifer_type="confined")
head_df <- grid_pts_head %>% bind_cols(head_m=heads)

ggplot(head_df) + 
  geom_raster(aes(x,y,fill=head_m))  + 
  geom_sf(data=pts_utm %>% filter(type=="pumping"), aes(size=abs(rate)),shape=1,stroke=1.5) +
  geom_sf(data=pts_utm %>% filter(type=="injection"), aes(size=abs(rate)),shape=16) +
  geom_contour(aes(x,y,z=head_m),bins=15,color="gray",linetype="dashed")  + 
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_size_continuous(limits=c(3,4)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```

### Get flow direction

Getting flow direction is similar to getting hydraulic head -- the function `get_flowdir()` is a wrapper
around `get_hydraulic_head()` that incorporates a numeric derivative from the package `numDeriv`. Similar
to before, define set of coordinates of evenly spaced points. Then, use
these points and the `well_images` to generate hydraulic head using `get_flowdir()`.

```{r flowdir_confined, message=FALSE, warning=FALSE,fig.width=6,fig.height=3.5}
grid_pts_flowdir <- with(grid_bounds,crossing(x=seq(xmin,xmax,length.out=15),y=seq(ymin,ymax,length.out=10)))
flow_dir <- get_flowdir(grid_pts_flowdir,wells,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_df <- grid_pts_flowdir %>% bind_cols(flow_dir) %>%
  mutate(angle=atan(dy/dx),
         mag=sqrt(dx^2+dy^2),
         mag_norm=mag^(1/2)*3e3, # this scales the flow for the arrow plot
         dx_norm=cos(angle)*sign(dx)*mag_norm,
         dy_norm=sin(angle)*sign(dx)*mag_norm,
         x2=x+dx_norm,
         y2=y+dy_norm)

# plot the flow velocities
ggplot(flow_dir_df) + 
  geom_raster(aes(x,y,fill=mag_norm))  + 
  geom_sf(data=pts_utm, aes(),size=3) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax))
```

Now, plot the results together. 
```{r plot_confined,fig.width=8,fig.height=4.5}
ggplot(head_df) +
  geom_raster(aes(x,y,fill=head_m))  +
  geom_point(data=wells, aes(x=x0,y=y0),shape=1,stroke=1) +
  geom_contour(aes(x,y,z=head_m),bins=20,color="gray",linetype="dashed")  + 
  geom_segment(data=flow_dir_df,
               aes(x,y,xend=x2,yend=y2),
               arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
  coord_equal() +
  # coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax),crs = st_crs(wells)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
```

## Two wells in an aquifer with bounds on all sides

### Generate well images

To reproduce the boundaries, we need to generate image wells by mirroring wells across each of the boundaries. Wells are mirrored across no-flow ("NF") boundaries with the inverse rate of pumping, and across constant head ("CH") boundaries with the same pumping rate.

* This has not been tested with complex boundaries.
  + Use only straight lines.
  + No complex shapes.
  
Lastly, to know the effect of a well on any given location, we need to know the radius of influence of the well. This package provides a couple ways to do this through the `get_radius_of_influence` function. See `?get_radius_of_influence` for more resources. 

```{r well_imaging,fig.width=6,fig.height=3.5}
well_images <- generate_image_wells(wells,boundaries,num_levels=3) %>%
  mutate(roi=get_radius_of_influence(Ksat=0.0001,h=50,t=3600*24*365*100,n=0.4,method="aravin-numerov"))

well_roi <- gen_circles(well_images %>% rename(r=roi,x=x0,y=y0))

ggplot()  +
  geom_sf(data=boundaries, aes()) + 
  geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray") + 
  geom_point(data=well_images,aes(x0,y0),alpha=0.5) + 
  geom_polygon(data=well_roi,aes(x,y,group=id),alpha=0.3,color="black")
```

Some of the images wells are too far away to affect the aquifer. Select only the wells that have a mirror distance less than the radius of influence of the wells.

```{r well_imaging_filter,fig.width=6,fig.height=3.5}
well_images <- well_images %>% filter(max_mirror_dist<roi)
well_roi <- gen_circles(well_images %>% rename(r=roi,x=x0,y=y0))
ggplot()  +
  geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray")+
  geom_sf(data=boundaries, aes(color=as.factor(bID)),size=1) + 
  geom_polygon(data=well_roi,aes(x,y,group=id),alpha=0.1,color="black") + 
  geom_point(data=well_images,aes(x0,y0,fill=rate),alpha=0.5,size=3,shape=21) + 
  scale_fill_gradient2("Pumping rate",low="blue",mid="gray",high="red") +
  scale_color_discrete("Boundary")
```

### Check to ensure the boundaries are working as intended

**NOTE: THIS FUNCTION DOES NOT SEEM TO BE WORKING AS EXPECTED!**

The function `gg_bounds_behavior()` is a helper function to generate hydraulic properties at the boundaries. It obtains hydraulic head and the flow normal to the boundary. Normal flow is defined such that positive flow has some component in the x-direction (the y-direction depends on the normal vector for the boundary).

```{r check_bounds,fig.width=6,fig.height=4}
# NOTE: THIS FUNCTION DOES NOT SEEM TO BE WORKING AS EXPECTED!
gg_bounds_behavior<- plot_bounds_behavior(wells,well_images,boundaries,h0=100,Ksat=0.00001,aquifer_type="unconfined")
gridExtra::grid.arrange(gg_bounds_behavior$p_h,gg_bounds_behavior$p_f,nrow=1)

# ggplot(gg_bounds_behavior$bounds_behavior,aes(x,y)) + geom_raster(aes(fill=head)) + geom_contour(aes(z=head))
```
```{r check_segments_not_working,include=FALSE}
# segments <- rbind(
#   data.frame(m=-3.0720980,b=5980000) %>% mutate(x_1=279500,y_1=m*x_1+b,x_2=282500,y_2=m*x_2+b),
#   data.frame(m=-3.0720980,b=5975000) %>% mutate(x_1=278000,y_1=m*x_1+b,x_2=281000,y_2=m*x_2+b))
# segments <- segments %>%
#   mutate(y_unit=sqrt(1/(1+m^2)),x_unit=-sign(m)*sqrt(m^2/(1+m^2)),
#          sID=row_number())
# ggplot()  +
#   geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray")+
#   geom_sf(data=boundaries, aes(color=as.factor(bID)),size=1) + 
#   geom_point(data=well_images,aes(x0,y0,fill=rate),alpha=0.5,size=3,shape=21) + 
#   geom_segment(data=segments,aes(x_1,y_1,xend=x_2,yend=y_2),linetype="dashed") +
#   scale_fill_gradient2("Pumping rate",low="blue",mid="gray",high="red") +
#   scale_color_discrete("Boundary")
# seg_behavior <- get_segments_behavior(wells,segments,h0=100,Ksat=0.00001,aquifer_type="unconfined",length.out=100)
# ggplot(seg_behavior) + geom_line(aes(dist_rel,flow_normal)) + facet_wrap(~paste("segment",sID),scales="free")
```

### Generate hydraulic head

The `well_images` object contains a row for each pumping well. Because of the principle of superposition,
the hydraulic head at any given location is the sum of the effect on hydraulic head of all pumping wells.

First define set of coordinates with which to calculate head by defining a bounding box (`grid_bounds`) and
using `expand.grid` and `seq` to generate evenly spaced points in the variable `grid_pts_head`. Then, use
thes points and the `well_images` to generate hydraulic head using `get_hydraulic_head()`.

```{r hydraulic_head_unconfined,fig.width=7,fig.height=3}
# grid_bounds_unconf <- boundaries %>% st_coordinates() %>% as_tibble() %>%
#   summarize(xmin=min(X),xmax=max(X),ymin=min(Y),ymax=max(Y))
grid_bounds_unconf <- data.frame(xmin=265000,xmax=290000,ymin=5113000,ymax=5120000)
grid_pts_head_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=150),y=seq(ymin,ymax,length.out=100)))
heads_unconf <- get_hydraulic_head(grid_pts_head_unconf,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
head_unconf_df <- grid_pts_head_unconf %>% bind_cols(head_m=heads_unconf)

ggplot(head_unconf_df %>% mutate(influenced_by_wells=head_m!=100)) + 
  geom_raster(aes(x,y,fill=influenced_by_wells)) + 
  geom_sf(data=boundaries, aes()) + 
  ggtitle("Region of well influence")

ggplot(head_unconf_df) + 
  geom_raster(aes(x,y,fill=head_m))  + 
  geom_contour(aes(x,y,z=head_m),bins=20,color="gray",linetype="dashed")  + 
  geom_sf(data=boundaries, aes()) + 
  # geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray") + 
  geom_point(data=well_images %>% filter(level==0),aes(x0,y0)) +
  # geom_sf(data=pts_utm, aes(size=abs(rate),shape=type)) +
  coord_sf(xlim=c(grid_bounds_unconf$xmin,grid_bounds_unconf$xmax),ylim=c(grid_bounds_unconf$ymin,grid_bounds_unconf$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```

### Get flow direction

Getting flow direction is similar to getting hydraulic head -- the function `get_flowdir()` is a wrapper
around `get_hydraulic_head()` that incorporates a numeric derivative from the package `numDeriv`. Similar
to before, define set of coordinates of evenly spaced points. Then, use
these points and the `well_images` to generate hydraulic head using `get_flowdir()`.

```{r flowdir_unconfined, message=FALSE, warning=FALSE,fig.width=6,fig.height=3.5}
grid_pts_flowdir_unconf <- with(grid_bounds_unconf,crossing(x=seq(xmin,xmax,length.out=30),y=seq(ymin,ymax,length.out=20)))
flow_dir_unconf <- get_flowdir(grid_pts_flowdir_unconf,well_images,h0=100,Ksat=0.00001,aquifer_type="unconfined")
# the dx_norm and dy_norm are used to make the arrows visible in the plot that follows.
flow_dir_unconf_df <- grid_pts_flowdir_unconf %>% bind_cols(flow_dir_unconf) %>%
  mutate(angle=atan(dy/dx),
         mag=sqrt(dx^2+dy^2),
         mag_norm=mag^(1/3)*1e3,
         dx_norm=cos(angle)*sign(dx)*mag_norm,
         dy_norm=sin(angle)*sign(dx)*mag_norm,
         x2=x+dx_norm,
         y2=y+dy_norm)
# flow_dir_check <- flow_dir_df %>% select(dx,dx_norm,dy,dy_norm) %>%
#   mutate(check=sign(dx)==sign(dx_norm) & sign(dy)== sign(dy_norm))

# plot the flow velocities
ggplot(flow_dir_unconf_df) + 
  geom_raster(aes(x,y,fill=mag_norm))  + 
  geom_sf(data=boundaries, aes()) + 
  geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray") + 
  geom_point(data=well_images %>% filter(level==0),aes(x0,y0)) +
  coord_sf(xlim=c(grid_bounds_unconf$xmin,grid_bounds_unconf$xmax),
           ylim=c(grid_bounds_unconf$ymin,grid_bounds_unconf$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4))
```


Now, plot the results together. 
```{r plot_unconfined,fig.width=6,fig.height=3.5}
ggplot(head_unconf_df) +
  geom_raster(aes(x,y,fill=head_m))  +
  geom_sf(data=boundaries, aes()) + 
  geom_contour(aes(x,y,z=head_m),bins=20,color="gray",linetype="dashed")  + 
  # geom_sf(data=boundaries_utm, aes(), linetype="dashed",alpha=0.5,color="gray") + 
  geom_point(data=well_images %>% filter(level==0),aes(x0,y0)) +
  geom_segment(data=flow_dir_unconf_df,
               aes(x,y,xend=x2,yend=y2),arrow = arrow(ends="last",type="closed",length=unit(1,"mm"))) +
  coord_sf(xlim=c(grid_bounds$xmin,grid_bounds$xmax),ylim=c(grid_bounds$ymin,grid_bounds$ymax)) +
  scale_shape_manual(values=c(1,16),limits=c(3,4)) #+ scale_size_continuous(limits=c(3,4))
```


